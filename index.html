<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- NOVO: Meta Tag de Verificação do Google AdSense -->
  <meta name="google-adsense-account" content="ca-pub-2957847231347233">
  
  <!-- INÍCIO: INTEGRAÇÃO GOOGLE ADSENSE (ID DE CLIENTE INSERIDO) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2957847231347233" crossorigin="anonymous"></script>
  <!-- FIM: INTEGRAÇÃO GOOGLE ADSENSE -->
  
  <!-- Content Security Policy: Garantindo que todos os recursos externos (CDNs e AdSense) sejam carregados via HTTPS -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://pagead2.googlesyndication.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://raw.githubusercontent.com https://github.com; media-src 'self' blob:;">
  <title>Analisador dos Formatos e Tamanhos dos Dedos dos Pés - By Irmo Zuccato Neto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Esconde todos os containers por padrão */
    #app-header-container, .result-container, .step-container { 
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        position: absolute;
        width: 100%;
    }
    .active-block { 
        display: block;
        opacity: 1;
        transform: translateY(0);
        position: relative;
    }
    .step-container.hiding {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
    }
    .custom-cursor { cursor: crosshair; }
    .bg-animation {
      background-color: #e0f2fe;
      background-image: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
    }
    .result-perfect { color: #ca8a04; }
    .result-very-close { color: #eab308; }
    .result-close { color: #f97316; }
    .result-far { color: #ef4444; }

    .progress-bar-perfect { background-color: #ca8a04; }
    .progress-bar-very-close { background-color: #eab308; }
    .progress-bar-close { background-color: #f97316; }
    .progress-bar-far { background-color: #ef4444; }
    
    /* Estilo para o Loading Spinner */
    .loading-spinner {
        border: 4px solid rgba(255, 255, 12, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 1.5rem;
        height: 1.5rem;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    /* Estilo CSS para o botão com formato de seta */
    .arrow-button {
        position: relative;
        padding-right: 3rem; /* Espaço para a seta */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .arrow-button::after {
        content: '';
        position: absolute;
        right: 0.5rem;
        width: 0;
        height: 0;
        border-top: 0.5rem solid transparent;
        border-bottom: 0.5rem solid transparent;
        border-left: 0.5rem solid white; /* Cor da seta */
        transition: transform 0.2s;
    }
    .arrow-button:hover::after {
        transform: translateX(0.25rem); /* Movimento da seta no hover */
    }
    /* Adiciona transição suave para a animação de altura */
    .block-transition {
        transition: height 0.5s ease-in-out;
        overflow: hidden;
        position: relative;
        min-height: 400px; /* Garante espaço para a transição */
    }
    #app-main-content {
        position: relative;
    }

    #capture-flash {
        transition: opacity 0.1s ease-out;
    }

    /* Estilos para Impressão e PDF */
    @media print {
        body, html {
            background-color: white;
        }
        body * {
            visibility: hidden;
        }
        #final-report-block, #final-report-block * {
            visibility: visible;
        }
        #final-report-image {
            visibility: visible !important; /* Garante que a imagem seja impressa */
        }
        #final-report-block {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            border: none;
            box-shadow: none;
            margin: 0;
            padding: 0;
        }
        /* Esconde os botões na impressão */
        #final-report-block .action-buttons {
            display: none;
        }
        /* Esconde o anúncio na impressão */
        .ads-container {
            display: none;
        }
    }

    /* Estilo para a notificação de cópia */
    #copy-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2f3640;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        pointer-events: none;
        transform: translate(-50%, 20px);
    }
    #copy-notification.show {
        opacity: 1;
        transform: translate(-50%, 0);
    }
    
    /* Justificar texto do relatório final */
    #expert-analysis-result {
        text-align: justify;
    }
    
    #expert-analysis-result p {
        text-align: justify;
    }
</style>
</head>
<body class="bg-animation min-h-screen p-4 sm:p-8 text-gray-800 flex items-center justify-center">

  <div id="app-main-content" class="max-w-4xl w-full mx-auto block-transition">
    <!-- Título/Header (Será escondido após o splash screen) -->
    <div id="app-header-container">
        <header class="text-center mb-6 sm:mb-10">
          <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">Analisador dos Formatos e Tamanhos dos Dedos dos Pés</h1>
          <p class="text-base sm:text-xl text-gray-600">By IRMO ZUCCATO NETO</p>
        </header>
    </div>

    <!-- Tela Inicial -->
    <div id="splash-screen" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center transition-all duration-300 active-block">
      
      <!-- LOGO ADICIONADO AQUI -->
      <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/LOGO.jpg" alt="Logo do Irmo Zuccato Neto" class="mx-auto mb-6 rounded-full shadow-lg" style="max-width: 150px; height: auto;">
      
      <h2 class="text-xl sm:text-2xl font-bold mb-4">Analisador dos Formatos e Tamanhos dos Dedos dos Pés</h2>
      <p class="text-lg sm:text-xl text-gray-700 mb-8">VAMOS DESCOBRIR QUAL O FORMATO DOS SEUS PÉS E O TAMANHO DOS SEUS DEDOS!!!!</p>
      <button id="start-button" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:from-blue-600 hover:to-blue-700 cursor-pointer transition-transform duration-200 transform hover:scale-105">
        Começar
      </button>
      <!-- NOVO: Link para Termos Legais (Splash Screen) -->
      <p class="text-xs text-gray-500 mt-4">
        Ao continuar, você concorda com os <a href="#" id="open-terms-splash" class="text-blue-600 hover:text-blue-800 underline font-medium">Termos de Uso e Política de Privacidade</a>.
      </p>
    </div>

    <!-- Bloco de Personalização (Novo Bloco) -->
    <div id="personalization-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center transition-all duration-300 step-container">
        
        <!-- INÍCIO: Anúncio no Bloco de Personalização -->
        <div id="ads-personalization" class="ads-container mb-6">
            <!-- Container do Anúncio (Será preenchido via JavaScript) -->
        </div>
        <!-- FIM: Anúncio no Bloco de Personalização -->

        <!-- Ajuste para centralizar o cabeçalho e empilhar no mobile -->
        <div class="flex flex-col sm:flex-row items-center justify-center sm:mb-6 mb-4">
            <!-- IMAGEM DE BOAS VINDAS (Tamanho ajustado para largura: 150px, altura: 100px) -->
            <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pes/main/IMAGENS%20APP/LOGO%20OLA.png" 
                 alt="Logo de Boas-Vindas" 
                 class="shadow-md sm:mr-4 mx-auto mb-4 sm:mb-0" 
                 style="width: 150px; height: 100px; max-width: 150px; border-radius: 10px;">
            
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">VAMOS COMEÇAR...</h2>
        </div>
        
        <div class="mb-6 text-left">
            <label for="user-name-input" class="block text-gray-700 font-semibold mb-2">Qual é o seu nome?</label>
            <input type="text" id="user-name-input" placeholder="Seu nome" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="mb-6 text-left">
            <label class="block text-gray-700 font-semibold mb-2">Para quem é a análise?</label>
            <select id="analysis-target-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <option value="me" selected>Para mim</option>
                <option value="client">Para um(a) cliente</option>
            </select>
        </div>

        <div id="client-name-group" class="mb-8 text-left step-container">
            <label for="client-name-input" class="block text-gray-700 font-semibold mb-2">Nome do(a) Cliente:</label>
            <input type="text" id="client-name-input" placeholder="Nome do Cliente" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <button id="continue-to-upload" class="bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 cursor-pointer transition-transform duration-200 transform hover:scale-105">
          Prosseguir para o Upload
        </button>
        <p id="personalization-error" class="text-red-500 text-sm mt-4 hidden">Por favor, preencha todos os nomes necessários.</p>
        <!-- NOVO: Link para Termos Legais (Personalization Block) -->
        <p class="text-xs text-gray-500 mt-6">
            Leia os <a href="#" id="open-terms-personalization" class="text-blue-600 hover:text-blue-800 underline font-medium">Termos Legais</a> completos antes de continuar.
        </p>
    </div>
    
    <!-- Bloco de Upload (Agora é a tela de escolha) -->
    <div id="upload-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center transition-all duration-300 step-container">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4">Adicione uma foto do pé de <span id="target-name-display" class="text-blue-600"></span></h2>
        <p class="text-gray-500 mb-6">A foto deve ser clara, de boa qualidade, tirada de cima e de frente, como no exemplo abaixo:</p>
        <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%2002.PNG" alt="Exemplo de foto para upload" class="mx-auto rounded-lg shadow-md mb-6 w-full max-w-sm h-auto">
        
        <div class="flex flex-col sm:flex-row justify-center gap-4">
            <!-- NOVO MÉTODO PARA "TIRAR FOTO" (Input File com Capture) -->
            <!-- Adicionamos a classe 'mobile-only' para esconder este botão no desktop via JS -->
            <label for="native-camera-input" id="open-camera-button-label" class="bg-blue-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors cursor-pointer inline-flex items-center justify-center mobile-only">
                📸 Tirar Foto (Câmera Nativa)
                <!-- Input oculto que abre a câmera nativa (prioridade para a traseira) -->
                <input type="file" id="native-camera-input" accept="image/*" class="hidden" capture="environment">
            </label>
            
            <label for="image-upload" class="bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 cursor-pointer transition-colors inline-flex items-center justify-center">
                📁 Fazer Upload
                <input type="file" id="image-upload" accept="image/*" class="hidden">
            </label>
        </div>
        <!-- Nova mensagem de orientação condicional para desktop -->
        <p id="camera-error" class="text-red-500 text-sm mt-4 hidden">Se você está no computador, use o botão "Fazer Upload" para selecionar a imagem.</p>
    </div>

    <!-- Bloco da Câmera (AGORA DESATIVADO NO FLUXO DE BOTÃO 'TIRAR FOTO') -->
    <div id="camera-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg text-center transition-all duration-300 step-container">
        <p class="text-gray-500 mb-4">Posicione o pé no centro da câmera e tire a foto.</p>
        <div class="relative bg-black rounded-lg overflow-hidden w-full max-w-md mx-auto aspect-video">
            <!-- Mantemos o VIDEO para fins de código, mas ele não será ativado pelo botão 'Tirar Foto' -->
            <video id="camera-preview" class="w-full h-full" autoplay playsinline muted></video>
            <div id="capture-flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
        </div>
        <div class="mt-4 flex justify-center items-center gap-4">
            <button id="capture-button" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Tirar Foto">
                <svg class="w-8 h-8 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm4 4a2 2 0 104 0 2 2 0 00-4 0z"></path></svg>
            </button>
            <button id="switch-camera-button" class="p-3 bg-gray-200 rounded-full hidden" aria-label="Trocar Câmera">
                <svg class="w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"/></svg>
            </button>
        </div>
        <button id="cancel-camera-button" class="mt-4 text-gray-600 hover:text-gray-800">Voltar</button>
    </div>

    <!-- Bloco de Confirmação da Foto Capturada (Usado pelo Input Nativo) -->
    <div id="preview-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg text-center transition-all duration-300 step-container">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4">Confirme a Foto</h2>
        <!-- O JS deve usar esta pré-visualização, mas o preview-block agora apenas move a foto para medição -->
        <img id="photo-preview" src="" alt="Foto capturada" class="mx-auto rounded-lg shadow-md mb-6 w-full max-w-md h-auto" style="transition: transform 0.3s ease;">
        <div class="flex flex-col gap-4">
            <div class="flex justify-center gap-4">
                <button id="rotate-left-button" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors">🔄 Girar para a Esquerda</button>
                <button id="rotate-right-button" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors">🔄 Girar para a Direita</button>
            </div>
            <div class="flex justify-center gap-4">
                <!-- Se o usuário clicar em "Tirar Outra" aqui, ele dispara o input nativo novamente -->
                <button id="retake-photo-button" class="bg-gray-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-colors">Tirar Outra</button>
                <button id="use-photo-button" class="bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 transition-colors">Usar Foto</button>
            </div>
        </div>
    </div>

    <!-- Tela de Instruções do Formato do Pé (Novo Bloco) -->
    <div id="shape-instruction-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-blue-300 text-center transition-all duration-300 step-container">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Instruções para a Análise do Formato</h2>
        <p class="text-gray-600 mb-6">Observe a imagem abaixo para entender onde as marcações das pontas dos dedos devem ser feitas.</p>
        <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%20F%20P%C3%89S.PNG" alt="Exemplo de marcação para formato do pé" class="mx-auto rounded-lg shadow-md mb-8 w-full max-w-md h-auto border-2 border-gray-200">
        <button id="continue-to-shape-measurement" class="bg-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-700 cursor-pointer transition-transform duration-200 transform hover:scale-105">
          Continuar
        </button>
    </div>
    <!-- Tela de Instruções da Razão Áurea (Etapa 2) -->
    <div id="ratio-instruction-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-yellow-300 text-center transition-all duration-300 step-container">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Instruções para a Análise do Tamanho dos Dedos</h2>
      <p class="text-gray-600 mb-4">Você precisará fazer TRÊS marcações na imagem do pé:</p>
      
      <div class="text-left bg-yellow-50 p-4 rounded-lg mb-6 border-l-4 border-yellow-400">
        <ol class="list-decimal pl-5 space-y-3">
          <li><strong>Ponta do 2º dedo</strong> (dedo ao lado do dedão)</li>
          <li><strong>Base do 2º dedo</strong> (onde o dedo começa no pé)</li>
          <li><strong>Final do peito do pé</strong> (parte mais saliente antes do tornozelo)</li>
        </ol>
      </div>

      <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%20T%20DEDOS.jpeg" alt="Exemplo de marcação para tamanho dos dedos" class="mx-auto rounded-lg shadow-md mb-8 w-full max-w-md h-auto border-2 border-gray-200">
      
      <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-400">
        <p class="font-semibold text-blue-800">Dica:</p>
        <p class="text-blue-700">Aponte e clique exatamente nos locais indicados acima. Você verá números aparecerem nas marcações.</p>
      </div>

      <button id="continue-to-ratio-measurement" class="bg-red-700 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-800 transition-transform duration-200 transform hover:scale-105">
        Entendi, Continuar
      </button>
    </div>
<!-- Medição (Comum para ambas as fases) -->
    <div id="measurement-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition-all duration-300 step-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Marque os Pontos</h2>
        <button id="redo-button" class="flex items-center gap-2 bg-gray-200 text-gray-700 py-2 px-4 rounded-full font-medium hover:bg-gray-300 transition-colors text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M4 20h5v-5M20 4h-5v5"/></svg>
            Refazer Marcações
        </button>
      </div>
      <p id="instruction" class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-4 rounded-md font-medium"></p>
      <div class="relative bg-gray-50 rounded-lg overflow-hidden border-2 border-gray-300">
        <canvas id="imageCanvas" class="w-full h-auto custom-cursor"></canvas>
      </div>
      <div id="progress-container" class="mt-4 grid grid-cols-4 gap-2"></div>
      <button id="calculate-button" class="mt-4 w-full bg-blue-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-600 transition-colors hidden">Calcular</button>
    </div>
    
    <!-- Resultado Formato -->
    <div id="shape-result-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-blue-300 transition-all duration-300 result-container">
      <div class="flex flex-col gap-6">
        <!-- Primeira linha: Imagem e resultado -->
        <div class="flex flex-col sm:flex-row gap-8">
          <div class="flex-1">
            <img id="shape-result-image" src="" alt="Foto do Pé" class="rounded-lg shadow-md mb-4 w-full h-auto">
          </div>
          <div class="flex-1 text-center">
            <h2 class="text-xl sm:text-2xl font-bold mb-2">Resultado do Formato do Pé</h2>
            <div class="text-5xl font-extrabold mb-4" id="shape-emoji"></div>
            <img id="shape-image" class="hidden mx-auto mb-4" src="" alt="Representação do formato do pé" style="width: 200px; height: auto;">
            <div class="text-xl font-semibold mb-6" id="shape-text"></div>
            <p id="classification-reasoning" class="text-sm text-gray-600 mt-2"></p>
          </div>
        </div>
        
        <!-- Segunda linha: Quadro de medições à esquerda e botão à direita -->
        <div class="flex flex-col sm:flex-row gap-4 items-stretch mt-6">
          <div class="flex-1 flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200">
              <h3 class="text-base font-semibold text-gray-700 mb-2">Medições dos Dedos (em pixels)</h3>
              <p class="text-sm text-gray-600 mb-1">Dedão (L1): <span id="L1-value" class="font-bold text-gray-800"></span></p>
              <p class="text-sm text-gray-600 mb-1">Segundo Dedo (L2): <span id="L2-value" class="font-bold text-gray-800"></span></p>
              <p class="text-sm text-gray-600 mb-1">Terceiro Dedo (L3): <span id="L3-value" class="font-bold text-gray-800"></span></p>
              <p class="text-sm text-gray-600">Quinto Dedo (L5): <span id="L5-value" class="font-bold text-gray-800"></span></p>
          </div>
          <div class="flex-1 flex flex-col items-center justify-center p-8 rounded-lg bg-gray-50 border border-gray-200">
              <p class="text-4xl font-extrabold text-red-700 mb-4 animate-pulse">Próximo Passo:</p>
              <button id="analyze-ratio-button" class="w-full bg-red-700 text-white py-4 px-8 rounded-lg font-bold text-lg hover:bg-red-800 transition-colors transform hover:scale-105">
                  Analisar Tamanho dos Dedos
              </button>
          </div>
        </div>
        
        <!-- Terceira linha: Botão refazer centralizado -->
        <div class="w-full flex justify-center">
          <button id="back-to-shape-measurement-button" class="w-full sm:w-1/2 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
              Refazer Marcações
          </button>
        </div>
      </div>
    </div>

    <!-- Bloco de Resultado da Análise do Tamanho dos Dedos -->
    <div id="ratio-result-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-yellow-300 transition-all duration-300 result-container">
      <div class="flex flex-col sm:flex-row gap-8">
        <div class="flex-1">
          <img id="ratio-result-image" src="" alt="Foto do Pé com medições da Análise do Tamanho dos Dedos" class="rounded-lg shadow-md mb-4 w-full h-auto">
        </div>
        <div class="flex-1">
          <div class="text-center">
            <h2 class="text-xl sm:text-2xl font-bold mb-2">Resultado da Análise do Tamanho dos Dedos</h2>
            <div id="ratio-result-ratio" class="text-5xl font-extrabold result-perfect mb-4"></div>
            <div id="ratio-result-text" class="text-xl font-semibold mb-6"></div>
          </div>
          <div class="space-y-4 text-lg">
            <div class="flex justify-between">
              <span class="text-gray-600">Razão Calculada:</span>
              <span id="ratio-calculated-ratio" class="font-bold"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Medida do 2º Dedo (pixels):</span>
              <span id="ratio-toe-length" class="font-bold"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Medida do Peito do Pé (pixels):</span>
              <span id="ratio-foot-length" class="font-bold"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Análise do Tamanho dos Dedos Ideal:</span>
              <span class="font-bold text-yellow-600">1.618</span>
            </div>
          </div>
          <div class="mt-8">
            <p class="text-center text-sm text-gray-500 mb-2">Proximidade com a Razão Ideal</p>
            <div class="relative w-full h-3 bg-gray-200 rounded-full">
                <div id="ratio-progress-bar" class="absolute h-3 rounded-full transition-all duration-500"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 mt-4">
        <button id="back-to-ratio-measurement-button" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-600 transition-colors">Refazer Marcações</button>
        <button id="new-ratio-analysis-button" class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">Análise das Unhas</button>
      </div>
    </div>
    
    <!-- Pergunta sobre Unhas -->
    <div id="nails-question-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-orange-300 transition-all duration-300 step-container">
        <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mb-6 text-center">Análise das Unhas dos Pés</h2>
        
        <div class="flex flex-col sm:flex-row gap-8 items-center mb-8">
            <div class="flex-1">
                <img id="nails-result-image" src="" alt="Foto do Pé para análise de unhas" class="rounded-lg shadow-xl w-full h-auto border-4 border-gray-200">
            </div>
            <div class="flex-1">
                <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/TAMANHO%20UNHAS.png" alt="Exemplo de tamanho de unhas" class="rounded-lg shadow-xl w-full h-auto border-4 border-gray-200">
            </div>
        </div>

        <div class="text-center">
            <p class="text-xl font-semibold mb-4">A maioria das suas unhas dos pés são:</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="pouco-visiveis" class="mb-2">
                    <span class="font-medium">POUCO VISÍVEIS</span>
                </label>
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="visiveis" class="mb-2">
                    <span class="font-medium">VISÍVEIS</span>
                </label>
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="bem-visiveis" class="mb-2">
                    <span class="font-medium">BEM VISÍVEIS</span>
                </label>
            </div>
            
            <p id="nails-error" class="text-red-500 text-sm mt-4 hidden">Por favor, selecione uma opção para prosseguir.</p>

            <button id="continue-to-personal-questions" class="bg-purple-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-purple-700 transition-colors">
                Próximas Perguntas
            </button>
        </div>
    </div>
    <!-- Questionário Pessoal Otimizado -->
    <div id="personal-questions-block" class="bg-white p-6 sm:p-10 rounded-xl shadow-lg border-2 border-purple-200 transition-all duration-300 step-container max-w-3xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Perguntas Complementares</h2>
            <p class="text-gray-600">Responda para completar sua análise</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                <div class="bg-purple-500 h-2 rounded-full" style="width: 50%"></div> <!-- Ajuste a barra de progresso -->
            </div>
        </div>

        <form id="personal-questions-form" class="space-y-6">
            <!-- Pergunta 1: Cócegas nos Pés -->
            <div class="bg-purple-50 rounded-xl p-6">
                <div class="flex items-center mb-3">
                    <span class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3">1</span>
                    <label class="text-lg font-semibold text-gray-800">Você tem cócegas nos pés?</label>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question1" value="Sim" class="sr-only">
                        <span class="font-medium">Sim</span>
                    </label>
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question1" value="Não" class="sr-only">
                        <span class="font-medium">Não</span>
                    </label>
                </div>
            </div>

            <!-- Pergunta 2: Relação com os Pés -->
            <div class="bg-purple-50 rounded-xl p-6">
                <div class="flex items-center mb-3">
                    <span class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3">2</span>
                    <label class="text-lg font-semibold text-gray-800">Qual sua relação com os pés?</label>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                    <label class="flex flex-col items-center p-4 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer text-center">
                        <input type="radio" name="question2" value="Desconfortável" class="sr-only">
                        <span class="font-medium mb-1">Desconfortável</span>
                        <span class="text-xs text-gray-500">Inseguro com meus pés</span>
                    </label>
                    <label class="flex flex-col items-center p-4 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer text-center">
                        <input type="radio" name="question2" value="Neutro" class="sr-only">
                        <span class="font-medium mb-1">Neutro</span>
                        <span class="text-xs text-gray-500">Indiferente</span>
                    </label>
                    <label class="flex flex-col items-center p-4 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer text-center">
                        <input type="radio" name="question2" value="Confortável" class="sr-only">
                        <span class="font-medium mb-1">Confortável</span>
                        <span class="text-xs text-gray-500">À vontade</span>
                    </label>
                    <label class="flex flex-col items-center p-4 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer text-center">
                        <input type="radio" name="question2" value="Muito Confortável" class="sr-only">
                        <span class="font-medium mb-1">Muito Confortável</span>
                        <span class="text-xs text-gray-500">Totalmente natural</span>
                    </label>
                </div>
            </div>
            
            <!-- NOVA Pergunta 3: Joanetes -->
            <div class="bg-purple-50 rounded-xl p-6">
                <div class="flex items-center mb-3">
                    <span class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3">3</span>
                    <label class="text-lg font-semibold text-gray-800">Você tem joanetes?</label>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question3" value="Sim" class="sr-only">
                        <span class="font-medium">Sim</span>
                    </label>
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question3" value="Não" class="sr-only">
                        <span class="font-medium">Não</span>
                    </label>
                </div>
            </div>

            <!-- NOVA Pergunta 4: Calos nos Dedos -->
            <div class="bg-purple-50 rounded-xl p-6">
                <div class="flex items-center mb-3">
                    <span class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3">4</span>
                    <label class="text-lg font-semibold text-gray-800">Você tem calos nos dedos?</label>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question4" value="Sim" class="sr-only">
                        <span class="font-medium">Sim</span>
                    </label>
                    <label class="flex items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-colors cursor-pointer">
                        <input type="radio" name="question4" value="Não" class="sr-only">
                        <span class="font-medium">Não</span>
                    </label>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button type="button" id="generate-final-report-button" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 px-10 rounded-xl font-bold shadow-lg hover:from-purple-700 hover:to-purple-800 cursor-pointer transition-all duration-300 transform hover:scale-[1.02] inline-flex items-center">
                    <span id="button-text">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        Gerar Relatório Final
                    </span>
                    <span id="loading-spinner" class="hidden loading-spinner"></span>
                </button>
                <p id="questions-error" class="text-red-500 text-sm mt-3 hidden">Por favor, responda todas as perguntas.</p>
            </div>
        </form>
    </div>
<!-- Relatório Completo de Análise -->
<div id="final-report-block" class="bg-white p-8 sm:p-12 rounded-xl shadow-lg border-2 border-green-300 transition-all duration-300 step-container">
    
    <!-- Título -->
    <div class="text-center mb-10 pb-6 border-b border-gray-200">
        <h2 class="text-2xl sm:text-3xl font-bold text-teal-700 mb-3">Relatório da ANÁLISE DOS PÉS - By @IrmoNeto</h2>
        <p class="text-xl text-gray-700">Para: <span id="report-target-name" class="font-bold text-teal-600"></span></p>
    </div>

    <!-- Container Superior: Resumo e Foto -->
    <div id="report-summary-container" class="flex flex-col sm:flex-row gap-8 items-start mb-10">
        <!-- Container Esquerdo: Resultados Iniciais -->
        <div class="flex-1 w-full bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Resumo da Análise</h3>
            <ul class="space-y-3 text-gray-700 mt-4">
                <li class="flex justify-between"><strong>Formato do Pé:</strong> <span id="summary-shape" class="font-semibold text-right"></span></li>
                <li class="flex justify-between"><strong>Tamanho dos Dedos:</strong> <span id="summary-ratio" class="font-semibold text-right"></span></li>
                <li class="flex justify-between"><strong>Tamanho das Unhas:</strong> <span id="summary-nails" class="font-semibold text-right"></span></li> 
                <li class="flex justify-between"><strong>Cócegas nos Pés:</strong> <span id="summary-tickles" class="font-semibold text-right"></span></li> 
                <li class="flex justify-between"><strong>Relação com os Pés:</strong> <span id="summary-relation" class="font-semibold text-right"></span></li>
                <li class="flex justify-between"><strong>Joanetes:</strong> <span id="summary-joanetes" class="font-semibold text-right"></span></li>
                <li class="flex justify-between"><strong>Calos nos Dedos:</strong> <span id="summary-calos" class="font-semibold text-right"></span></li>
            </ul>
        </div>
        
        <!-- Container Direito: Foto -->
        <div class="w-full sm:w-1/3 flex justify-center items-center">
            <img id="final-report-image" 
                 src="" 
                 alt="Foto do Pé para Relatório" 
                 class="rounded-lg shadow-xl max-w-full h-auto border-4 border-gray-200"
                 style="max-width: 250px; max-height: 250px; object-fit: contain;"> <!-- Limitação de tamanho adicionada -->
        </div>
    </div>

    <!-- Container Inferior: Análise de Personalidade e CTA (Layout ajustado para celular) -->
    <div class="flex flex-col space-y-8">
        <h3 class="text-2xl font-extrabold text-gray-800 mb-4 text-center">Relatório de Análise da Personalidade pelos Pés</h3>
        
        <!-- Bloco de Análise Detalhada (Melhor espaçamento interno) -->
        <div id="expert-analysis-result" class="prose max-w-none text-gray-800 leading-relaxed bg-gray-50 p-6 sm:p-8 rounded-lg border-l-4 border-green-400">
            Aguardando os dados para gerar o relatório...
        </div>
        
        <!-- INÍCIO: Anúncio no Bloco de Relatório Final -->
        <div id="ads-final-report" class="ads-container mt-6 mb-4">
            <!-- Container do Anúncio (Será preenchido via JavaScript) -->
        </div>
        <!-- FIM: Anúncio no Bloco de Relatório Final -->

        <!-- CTA para Página de Vendas (Link Atualizado) -->
        <div class="mt-8 mb-4 text-center">
            <h4 class="text-xl font-bold text-gray-800 mb-4">Quer saber mais sobre o seu pé e como ele revela sua personalidade?</h4>
            <a href="https://irmoneto.github.io/INFOPRODUTOS-BY-IRMONETO/" target="_blank" class="inline-flex items-center justify-center bg-yellow-500 text-white py-3 px-8 rounded-full font-bold shadow-xl hover:bg-yellow-600 transition-colors transform hover:scale-[1.03] text-lg w-full sm:w-auto">
                CLIQUE AQUI E ACESSE MAIS CONTEÚDOS SOBRE O TEMA
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
            </a>
        </div>
    </div>
    
    <!-- Botões de Ação Final (Layout já era responsivo, mantido) -->
    <div class="mt-10 flex flex-col sm:flex-row justify-center items-center gap-4 action-buttons">
        <button id="save-analysis-button" class="bg-green-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-green-700 transition-colors w-full sm:w-auto">
            Salvar Relatório
        </button>
        <button id="share-analysis-button" class="bg-teal-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-700 transition-colors w-full sm:w-auto">
            Compartilhar Análise
        </button>
        <button id="start-new-full-analysis-button" class="bg-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-700 transition-colors w-full sm:w-auto">
            Realizar Nova Análise
        </button>
    </div>
</div>

<!-- NOVO BLOCO: DOCUMENTOS LEGAIS COMPLETOS -->
<div id="legal-documents-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-red-300 transition-all duration-300 step-container max-w-3xl mx-auto">
    <div class="text-center mb-6">
        <h2 class="text-2xl sm:text-3xl font-bold text-red-700 mb-2">Termos Legais do Aplicativo</h2>
        <p class="text-gray-600">Última atualização: Outubro de 2025</p>
    </div>

    <div class="space-y-8 text-gray-700 text-sm">
        
        <!-- TERMOS DE USO -->
        <div id="terms-of-use" class="border-b pb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3">1. TERMOS DE USO</h3>
            <p class="font-semibold mb-2">1.1. Direitos Autorais e Propriedade Intelectual</p>
            <p class="ml-4 mb-2">Todo o código, design, metodologia de análise e conteúdo textual (incluindo o Relatório Final) são de propriedade exclusiva do desenvolvedor, **Irmo Zuccato Neto**. A propriedade intelectual é protegida por leis de direitos autorais.</p>
            
            <p class="font-semibold mb-2">1.2. Limitações de Uso e Proibições</p>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li>O uso do aplicativo destina-se exclusivamente à análise pessoal ou de cliente, conforme as funcionalidades oferecidas.</li>
                <li>É estritamente **proibida** a reprodução, cópia, modificação, engenharia reversa, distribuição ou revenda do código ou da metodologia subjacente.</li>
                <li>A reprodução total ou parcial do Relatório Final para fins comerciais (venda, publicação em massa) sem autorização expressa do desenvolvedor é proibida.</li>
            </ul>
        </div>
        
        <!-- POLÍTICA DE PRIVACIDADE -->
        <div id="privacy-policy" class="border-b pb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3">2. POLÍTICA DE PRIVACIDADE</h3>
            <p class="font-semibold mb-2">2.1. Coleta e Uso de Dados</p>
            <p class="ml-4 mb-2">Coletamos apenas o **nome** do usuário e/ou cliente para fins de personalização do relatório. Estes nomes são exibidos no Relatório Final gerado, mas não são armazenados em um banco de dados persistente neste momento.</p>
            
            <p class="font-semibold mb-2">2.2. Armazenamento e Uso de Imagens</p>
            <p class="ml-4 mb-2">A **imagem do pé** é usada unicamente para a realização das medições visuais no dispositivo do usuário (navegador) e para inclusão no Relatório Final (PDF/Visualização). A imagem **não é enviada, armazenada ou compartilhada** com o desenvolvedor ou terceiros, sendo descartada após o encerramento da sessão ou início de nova análise.</p>
            
            <p class="font-semibold mb-2">2.3. Cookies e Rastreamento (Tracking)</p>
            <p class="ml-4">O aplicativo **não utiliza cookies** de rastreamento de terceiros (tracking) ou ferramentas de analytics que coletam dados pessoais. O uso do Tailwind CSS e HTML2PDF é baseado em CDNs de terceiros, mas sem coleta de dados específica do usuário por este aplicativo.</p>
        </div>

        <!-- LICENÇA DE SOFTWARE -->
        <div id="software-license" class="border-b pb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3">3. LICENÇA DE USO (USUÁRIO FINAL)</h3>
            <p class="font-semibold mb-2">3.1. Permissões Concedidas</p>
            <p class="ml-4 mb-2">É concedida ao usuário uma licença limitada, não exclusiva e intransferível para usar este software para fins pessoais ou profissionais de análise (clientes), conforme a proposta original.</p>
            
            <p class="font-semibold mb-2">3.2. Restrições e Penalidades</p>
            <p class="ml-4">A violação das limitações de uso e das proibições de reprodução (item 1) pode resultar em penalidades legais, incluindo, mas não se limitando a, ações por violação de direitos autorais e danos morais, conforme a legislação brasileira e internacional aplicável.</p>
        </div>

        <!-- AVISOS LEGAIS -->
        <div id="legal-disclaimers">
            <h3 class="text-xl font-bold text-gray-800 mb-3">4. AVISOS LEGAIS E LIMITAÇÃO DE RESPONSABILIDADE</h3>
            <p class="font-semibold mb-2">4.1. Disclaimer Médico</p>
            <p class="ml-4 mb-2 bg-yellow-100 p-2 rounded">**O Aplicativo não oferece diagnóstico médico, psicológico, quiroprático ou podológico.** A análise é baseada em estudos de leitura de pés com finalidade de autoconhecimento e desenvolvimento personal. Use o Relatório Final apenas como uma ferramenta complementar e não substitua a avaliação de um profissional de saúde qualificado.</p>
            
            <p class="font-semibold mb-2">4.2. Limitação de Responsabilidade</p>
            <p class="ml-4 mb-2">O desenvolvedor não se responsabiliza por quaisquer danos diretos ou indiretos decorrentes do uso (ou mau uso) da análise e das informações geradas por este aplicativo.</p>
            
            <p class="font-semibold mb-2">4.3. Jurisdição Aplicável</p>
            <p class="ml-4">Estes Termos e o uso do aplicativo são regidos pelas leis da República Federativa do Brasil.</p>
        </div>
    </div>
    
    <div class="mt-8 text-center">
        <button id="back-from-legal-button" class="bg-red-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-600 transition-colors">
            Voltar ao Aplicativo
        </button>
    </div>
</div>

  </div>

  <div id="copy-notification">Relatório copiado para a área de transferência!</div>

  <script>
    // --- Variáveis de Configuração do AdSense ---
    // ID DE CLIENTE JÁ INSERIDO
    const AD_CLIENT_ID = "ca-pub-2957847231347233"; 
    // AGUARDANDO ID DO SLOT (data-ad-slot) - **ESTE PRECISA SER SUBSTITUÍDO**
    const AD_SLOT_ID = "SEU_DATA_AD_SLOT_AQUI"; 
    
    // Função para criar o contêiner do anúncio
    function createAdContainer() {
        if (!AD_CLIENT_ID.includes('pub-') || !AD_SLOT_ID || AD_SLOT_ID === "SEU_DATA_AD_SLOT_AQUI") {
            console.warn("AD WARNING: ID do Slot do AdSense ainda não configurado. Usando um placeholder.");
            const placeholder = document.createElement('div');
            placeholder.className = 'w-full h-24 bg-gray-200 flex items-center justify-center text-gray-600 text-xs rounded-lg';
            placeholder.textContent = 'Espaço de Anúncio (Aguardando ID do Slot)';
            return placeholder;
        }

        const ins = document.createElement('ins');
        ins.className = 'adsbygoogle';
        ins.style.display = 'block';
        ins.style.textAlign = 'center';
        ins.setAttribute('data-ad-client', AD_CLIENT_ID);
        ins.setAttribute('data-ad-slot', AD_SLOT_ID);
        ins.setAttribute('data-ad-format', 'auto');
        ins.setAttribute('data-full-width-responsive', 'true');

        // Adiciona a tag <script> que dispara a renderização
        const script = document.createElement('script');
        script.textContent = '(adsbygoogle = window.adsbygoogle || []).push({});';

        const container = document.createElement('div');
        container.appendChild(ins);
        container.appendChild(script);
        
        return container;
    }
    
    // Função para renderizar o anúncio em um ID de contêiner específico
    function renderAd(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            // Limpa o contêiner e insere o novo anúncio
            container.innerHTML = '';
            container.appendChild(createAdContainer());
        }
    }
    // ----------------------------------------------------------------
    
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTOS HTML ---
      const appMainContent = document.getElementById('app-main-content');
      const splashScreen = document.getElementById('splash-screen');
      const personalizationBlock = document.getElementById('personalization-block');
      const uploadBlock = document.getElementById('upload-block');
      const measurementBlock = document.getElementById('measurement-block');
      const shapeInstructionBlock = document.getElementById('shape-instruction-block');
      const ratioInstructionBlock = document.getElementById('ratio-instruction-block');
      const shapeResultBlock = document.getElementById('shape-result-block');
      const ratioResultBlock = document.getElementById('ratio-result-block');
      const nailsQuestionBlock = document.getElementById('nails-question-block');
      const personalQuestionsBlock = document.getElementById('personal-questions-block');
      const finalReportBlock = document.getElementById('final-report-block');
      const appHeaderContainer = document.getElementById('app-header-container');
      const previewBlock = document.getElementById('preview-block');
      const cameraBlock = document.getElementById('camera-block');
      const legalDocumentsBlock = document.getElementById('legal-documents-block');


      // --- BOTÕES E FORMS ---
      const startButton = document.getElementById('start-button');
      const continueToUploadButton = document.getElementById('continue-to-upload');
      const analyzeRatioButton = document.getElementById('analyze-ratio-button');
      const newRatioAnalysisButton = document.getElementById('new-ratio-analysis-button');
      const continueToPersonalQuestions = document.getElementById('continue-to-personal-questions');
      const generateFinalReportButton = document.getElementById('generate-final-report-button');
      const backToShapeMeasurementButton = document.getElementById('back-to-shape-measurement-button');
      const backToRatioMeasurementButton = document.getElementById('back-to-ratio-measurement-button');
      const startNewFullAnalysisButton = document.getElementById('start-new-full-analysis-button');
      const imageUpload = document.getElementById('image-upload');
      const redoButton = document.getElementById('redo-button');
      const calculateButton = document.getElementById('calculate-button');
      // Novo input para a câmera nativa
      const nativeCameraInput = document.getElementById('native-camera-input');
      const openCameraButtonLabel = document.getElementById('open-camera-button-label');
      
      const nailsError = document.getElementById('nails-error');
      const questionsError = document.getElementById('questions-error');
      const personalQuestionsForm = document.getElementById('personal-questions-form');

      // Referências para o loading e texto do botão
      const loadingSpinner = document.getElementById('loading-spinner');
      const buttonTextSpan = document.getElementById('button-text');
      const expertAnalysisResult = document.getElementById('expert-analysis-result');
      
      const continueToShapeMeasurement = document.getElementById('continue-to-shape-measurement');
      const continueToRatioMeasurement = document.getElementById('continue-to-ratio-measurement');


      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const goldenRatioIdeal = 1.618;

      // --- Variáveis de Estado ---
      let points = [];
      let currentStep = 1;
      let img = new Image();
      let imageUrl = '';
      let currentAnalysisPhase = 'shape';
      let userName = '';
      let clientName = '';
      let shapeResultText = '';
      let ratioResultText = '';
      let personalAnswers = {};
      let currentStream = null;
      let facingMode = 'environment';
      let currentRotation = 0;
      let previousBlockId = 'splash-screen'; // Rastreia o bloco anterior para o botão "Voltar"

      // --- Elementos da Câmera ---
      // const openCameraButton = document.getElementById('open-camera-button'); // DESATIVADO NO FLUXO NATIVO
      const cameraPreview = document.getElementById('camera-preview');
      const captureButton = document.getElementById('capture-button');
      const switchCameraButton = document.getElementById('switch-camera-button');
      const cancelCameraButton = document.getElementById('cancel-camera-button');
      const cameraError = document.getElementById('camera-error');
      const photoPreview = document.getElementById('photo-preview');
      const retakePhotoButton = document.getElementById('retake-photo-button');
      const usePhotoButton = document.getElementById('use-photo-button');
      const captureFlash = document.getElementById('capture-flash');
      const rotateLeftButton = document.getElementById('rotate-left-button');
      const rotateRightButton = document.getElementById('rotate-right-button');
      const backFromLegalButton = document.getElementById('back-from-legal-button');


      const shapeStepLabels = ['Ponta do Hálux', 'Ponta do 2º Dedo', 'Ponta do 3º Dedo', 'Ponta do 5º Dedo'];
      const ratioStepLabels = ['Ponta do 2º Dedo', 'Início do 2º Dedo', 'Fim do Peito do Pé'];
      
      const analysisData = {
          'Formato do Pé': {
              'Egípcio': 'uma pessoa prática e objetiva, com predomínio do pensamento linear, que tem tendência ao perfeccionismo, busca clareza e sequência lógica nas ações, valorizando a ordem e a previsibilidade.',
              'Grego/Romano': 'uma pessoa com predomínio do pensamento sistêmico, que tende à criação de esquemas e planos, apresentando detalhismo e uma necessidade de compreender a totalidade antes de agir.',
              'Quadrado': 'uma pessoa com predomínio do pensamento digital, que gosta de integrar tudo a tudo e com tudo, mostrando uma tendência ao utopismo e à busca por coerência total entre as partes.'
          },
          'Tamanho dos Dedos': {
              'Curtos': 'Pessoas diretas, objetivas e práticas. Agem rapidamente diante das demandas, com foco em resultados imediatos. Preferem o concreto ao abstrato, valorizam eficiência e clareza. Costumam ser resolutivas, mas podem ter impaciência com processos demorados e introspectivos. Tendem a expressar-se com firmeza e buscar o que é útil e palpável.',
              'Normais para Curtos': 'Personalidade que combina praticidade e sensibilidade. Apresenta características dos dedos curtos (ação direta, foco no imediato, praticidade) e dos dedos normais (equilíbrio, ponderação e percepção emocional). Busca resultados, mas sem perder o vínculo com o outro. Sabe agir com agilidade, mas também considera o impacto emocional das decisões. Pode alternar entre impulso e reflexão leve.',
              'Normais': 'Representam equilíbrio entre ação, emoção e reflexão. Pessoas que conseguem pensar, sentir e agir de forma proporcional, adaptando-se bem às demandas da realidade. São flexíveis, ponderadas e coerentes. Conseguem unir objetividade e sensibilidade, respondendo com equilíbrio entre razão e intuição. Tendem a manter estabilidade emocional e clareza mental.',
              'Normais para Longos': 'Personalidade com predominância emocional e mental. Reúne características dos dedos normais (equilíbrio e adaptação) e dos longos (reflexão profunda e sensibilidade ampliada). São pessoas que pensam e sentem com intensidade, tendendo a buscar significado nas experiências. Podem alternar entre ponderação e idealismo, combinando empatia e visão analítica.',
              'Longos': 'Pessoas reflexivas, analíticas e detalhistas. Tendem à introspecção, imaginação e busca por sentido nas experiências. Valorizam a compreensão antes da ação, preferindo o abstrato ao imediato. Demonstram sensibilidade emocional e profundidade intelectual. Podem ser visionárias e criativas, mas precisam cuidar para não ficar presas na idealização ou no excesso de pensamento.'
          },
          'Pontos Fortes': {
              'Curtos': 'Agilidade para agir e resolver situações práticas, espírito objetivo, direto e assertivo, capacidade de simplificar o complexo e transformar ideias em ações concretas, além de tomada de decisão rápida e senso de oportunidade.',
              'Normais para Curtos': 'Equilíbrio entre ação e emoção, sabendo agir com sensibilidade e objetividade. Tem capacidade de resolver sem perder a empatia, conciliando agilidade prática com percepção relacional e se adaptando bem a contextos dinâmicos.',
              'Normais': 'Harmonia entre pensar, sentir e agir, com flexibilidade cognitiva e emocional. Sabe avaliar, decidir e executar com equilíbrio, ponderando razão e intuição, o que a torna uma pessoa versátil e integradora.',
              'Normais para Longos': 'Sensibilidade emocional aliada à reflexão profunda, com capacidade de compreender nuances e agir com empatia e discernimento. Possui clareza de visão, vocação para análise e inspiração, integrando sentimento e racionalidade com elegância.',
              'Longos': 'Pensamento analítico, mente investigativa e imaginativa, com alta capacidade de abstração e visão estratégica. Busca sentido e profundidade em tudo que faz, com talento para síntese, reflexão e inovação.'
          },
          'Pontos Desafiadores': {
              'Curtos': 'A impaciência diante de processos lentos, a tendência a agir antes de refletir e a dificuldade em lidar com emoções mais sutis. Pode resistir à escuta ou à espera, buscando resolver rapidamente o que pede presença e sensibilidade.',
              'Normais para Curtos': 'A oscilação entre impulso e ponderação, pois em momentos de pressão tende à impaciência. Corre o risco de agir com boa intenção, porém sem planejamento, e precisa desenvolver maior tolerância à frustração.',
              'Normais': 'A tendência à indecisão diante de múltiplas perspectivas, podendo demorar para agir em busca do equilíbrio. Corre o risco de racionalizar excessivamente os sentimentos e precisa definir limites claros, confiando mais na intuição.',
              'Normais para Longos': 'A sensibilidade acentuada, que pode gerar sobrecarga emocional e fazê-la absorver excessivamente o ambiente. Pode se dispersar em análises ou idealizações, adiando a ação prática e precisando estruturar o pensamento.',
              'Longos': 'O excesso de reflexão que pode levar à paralisação na ação e a dificuldade em lidar com imprevistos. A tendência à autocrítica e idealização pode desconectá-la do corpo e do presente, necessitando aprender a agir com mais confiança.'
          },
          'Tamanho das Unhas': {
              'Pouco Visível': 'Pessoas que acreditam mais nas verdades externas e tendem a buscar segurança em referências do meio. Demonstram maior sensibilidade ao julgamento alheio e preferência por seguir modelos já validados. Podem apresentar rigidez cognitiva e resistência a mudanças, mantendo padrões de pensamento consolidados. Mostram necessidade de aprovação e cautela ao expressar opiniões próprias, revelando menor flexibilidade emocional e tendência ao conformismo.',
              'Visível': 'Indicam equilíbrio entre convicção pessoal e abertura para o novo. São pessoas capazes de sustentar suas ideias sem ignorar perspectivas externas. Demonstram flexibilidade cognitiva, senso crítico e capacidade de ajustar crenças diante de novas informações. Adaptam-se bem a contextos de mudança sem perder coerência interna. Mantêm harmonia entre firmeza e escuta, conciliando autenticidade e aprendizado.',
              'Bem Visível': 'Pessoas que acreditam mais nas próprias verdades e tendem a agir com autoconfiança e firmeza de opinião. Demonstram independência intelectual e segurança em suas escolhas. Adaptam-se bem às transformações sociais e são capazes de sustentar posições com clareza, desde que percebam sentido personal. No entanto, podem expressar teimosia, dificuldade em ceder e resistência em reconhecer falhas. Valorizam autenticidade e coerência, mas precisam cuidar para não confundir convicção com inflexibilidade.'
          },
          'Cócegas nos Pés': {
              'Sim': 'Indicam um sistema nervoso altamente responsivo e uma ligação direta com memórias corporais primárias, como experiências de toque e segurança no início da vida. Revelam emocionalidade viva, receptividade afetiva e sensibilidade instintiva a estímulos sutis. Essa resposta corporal sugere abertura ao contato, mas também possível vulnerabilidade diante do inesperado. Em alguns casos, pode refletir registros antigos de ansiedade ou excitação ligados ao toque, expressando a busca por controle diante da entrega.',
              'Não': 'Indicam um sistema nervoso mais estável e previsível, com menor reatividade a estímulos sutis. Revelam estrutura emocional consistente, autoconfiança e apego seguro. A ausência de cócegas sugere integração entre instinto e consciência, permitindo presença corporal sem sobressaltos. Essa característica aponta para um padrão de maturidade sensorial e controle emocional, embora possa, em certos contextos, refletir necessidade de manter distanciamento protetivo diante do toque ou da vulnerabilidade.'
          },
          'Relação com os Pés': {
              'Desconfortável': 'O desconforto diante dos pés expressa uma relação de distanciamento com aspectos instintivos, sensuais e afetivos do próprio corpo. Essa reação indica possíveis registros de repressão do prazer, vergonha corporal ou memórias associadas a controle e censura do toque. Reflete resistência em aceitar o instintivo e o natural, traduzindo dificuldade em se entregar plenamente às sensações e ao afeto. O corpo revela tensão entre o desejo de contato e o medo de perder o controle.',
              'Neutro': 'A relação neutra ou ambivalente com os pés demonstra um estado de transição entre repressão e aceitação. Há curiosidade e desejo de aproximação, mas ainda coexistem julgamentos sutis ou receio do prazer. Esse padrão reflete um processo de reconciliação entre instinto e consciência, razão e sensorialidade. A pessoa alterna entre momentos de abertura para o toque e outros de racionalização, indicando amadurecimento emocional e integração progressiva com o corpo.',
              'Confortável': 'O conforto com os pés revela uma relação harmônica entre corpo, prazer e presença. Indica aceitação dos impulsos naturais e abertura ao toque como linguagem de afeto, entrega e confiança. Há integração entre sensualidade e segurança emocional, refletindo maturidade na vivência do prazer e no reconhecimento do corpo como aliado da consciência. Essa naturalidade sugere equilíbrio entre instinto e autocontrole, leveza no contato e prazer em estar presente em si mesmo.'
          }
      };

      // DADOS OBTIDOS DA TABELA SIMPLIFICADA OUTUBRO.txt PARA JOANETES E CALOS
      const healthData = {
          // Descrição para SIM (Joanetes) - ATUALIZADA
          'Joanetes': {
              'Sim': 'A presença de joanetes são indícios de um esforço inconsciente para manter vínculos afetivos marcados por insegurança, talvez porque em algum momento, faltou amparo e a pessoa aprendeu a sustentar relações moldando-se ao outro, mesmo à custa de si.',
              // NOVO TEXTO PARA NÃO (Joanetes)
              'Não': 'A ausência de joanetes sugere uma estrutura de suporte interna robusta. Indica uma pessoa que tende a seguir seu caminho sem muito abalos quanto aos desvios causados por pressões ou conflitos com as figuras de autoridade da infância e juventude.'
          },
          // Descrição para SIM (Calos) - ATUALIZADA
          'Calos nos Dedos': {
              'Sim': 'Já, a presença de calos revelam acúmulo de energia reprimida — partes do ser que tentam se expressar, mas encontram bloqueios e refletem as defesas emocionais criadas por necessidade de proteção, geralmente associadas a experiências em que a pessoa sentiu que não podia reagir, expressar ou se posicionar frente a vida.',
              // NOVO TEXTO PARA NÃO (Calos)
              'Não': 'A ausência de calos sugere uma boa fluidez na adaptação em relação aos desafios da vida, com uma menor tendência a acumular tensões ou rigidez em seus padrões de externalizar seu mundo interior frente as situações da vida.'
          }
      };


      // FUNÇÃO AUXILIAR: GARANTE QUE AS IMAGENS ESTEJAM CARREGADAS
      function ensureImagesLoaded(element) {
          const images = element.querySelectorAll('img');
          const promises = Array.from(images).filter(img => img.src && !img.complete).map(img => {
              return new Promise(resolve => {
                  img.onload = resolve;
                  img.onerror = resolve; 
              });
          });
          return Promise.all(promises);
      }

      function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function(match) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match];
        });
      }

      function capitalizeFirst(str) {
          // Garante que a primeira letra seja maiúscula, mantendo o restante da string
          if (!str) return str;
          return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function ensurePunctuation(str) {
          // Garante que a string termine com um ponto final, a menos que já termine com ?, ! ou .
          if (!str) return str;
          const trimmed = str.trim();
          if (/[.?!]$/g.test(trimmed)) {
              return trimmed;
          }
          return trimmed + '.';
      }

      // Função de formatação mais flexível.
      // 1. Garante ponto final.
      // 2. Não força capitalização inicial, permitindo que a função chamadora decida (com lowerCaseFirst).
      function formatText(text) {
          if (!text) return text;
          // Não aplicamos capitalização de sentença aqui. Apenas garantimos a pontuação.
          return ensurePunctuation(text.trim());
      }
      
      // Nova função para descapitalizar a primeira letra, usada para inserção no meio da frase.
      function lowerCaseFirst(str) {
          if (!str) return str;
          return str.charAt(0).toLowerCase() + str.slice(1);
      }


      function generateFinalReportText(shape, ratio, nailsValue, tickles, relation, joanetes, calos) {
          const clientName = escapeHTML(document.getElementById('report-target-name').textContent);
          const nailsKeyMap = {'pouco-visiveis': 'Pouco Visível', 'visiveis': 'Visível', 'bem-visiveis': 'Bem Visível'};
          const nailsKey = nailsKeyMap[nailsValue] || 'Visível';
          let relationKey = relation === 'Muito Confortável' ? 'Confortável' : relation;
          let ratioKey = ratio === 'Normais (Análise do Tamanho dos Dedos)' ? 'Normais' : ratio;
          const relationDisplay = relationKey === 'Neutro' ? 'Neutra' : relationKey;
          
          
          // --- PREPARAÇÃO DOS TEXTOS ---
          
          // Formato do Pé: Usa lowerCaseFirst e formatText para fluir após "com tendência a"
          let shapeDescRaw = analysisData['Formato do Pé'][shape] || '';
          let shapeDesc = formatText(lowerCaseFirst(shapeDescRaw));

          // Tamanho dos Dedos: Usa lowerCaseFirst e formatText para fluir após "revelam sua tendência inata para"
          let ratioDescRaw = analysisData['Tamanho dos Dedos'][ratioKey] || '';
          let ratioDesc = formatText(lowerCaseFirst(ratioDescRaw));
          
          // Tamanho das Unhas: Usa lowerCaseFirst e formatText para fluir após "geralmente,"
          let nailsDescRaw = analysisData['Tamanho das Unhas'][nailsKey] || '';
          let nailsDesc = formatText(lowerCaseFirst(nailsDescRaw));
          
          const ticklesDesc = formatText(analysisData['Cócegas nos Pés'][tickles] || '');
          
          // Relação com os Pés: Usa lowerCaseFirst e formatText para fluir após "pois"
          let relationDescRaw = analysisData['Relação com os Pés'][relationKey] || '';
          let relationDesc = formatText(lowerCaseFirst(relationDescRaw));

          const strongPointsDesc = formatText(analysisData['Pontos Fortes'][ratioKey] || '');
          const challengingPointsRaw = analysisData['Pontos Desafiadores'][ratioKey] || ''; 
          
          // Joanetes e Calos: O texto base está começando com maiúscula, mas formatText garante o ponto final.
          const joanetesDesc = formatText(healthData['Joanetes'][joanetes] || '');
          const calosDesc = formatText(healthData['Calos nos Dedos'][calos] || '');

          // --- Formatação dos Pontos Desafiadores ---
          let challengingPointsList = challengingPointsRaw.replace(/[.?!]$/g, '').trim();
          
          // Descapitaliza a primeira palavra (artigo 'A', 'O', etc.)
          if (/[A-Z].*?\s/.test(challengingPointsList) && challengingPointsList.length > 0) {
              challengingPointsList = challengingPointsList.charAt(0).toLowerCase() + challengingPointsList.slice(1);
          }
          
          // Define o conector: usa ", com a/o "
          let connector = ", com ";
          
          if (challengingPointsList.toLowerCase().startsWith('o excesso')) {
               connector = ", com o ";
          } else if (challengingPointsList.toLowerCase().startsWith('a impaciência') ||
                     challengingPointsList.toLowerCase().startsWith('a oscilação') ||
                     challengingPointsList.toLowerCase().startsWith('a tendência') ||
                     challengingPointsList.toLowerCase().startsWith('a sensibilidade')) 
          {
              connector = ", com a ";
          }
          
          let challengingPointsFormatted = `${connector}${challengingPointsList}`;


          // Novo bloco consolidado de Joanetes e Calos
          let joanetesCalosBlock = '';
          
          if (joanetes === 'Não' && calos === 'Não') {
               // Cenário específico de ausência de ambas as marcas, conforme solicitado
               joanetesCalosBlock = `
                 <p class="mt-3">${joanetesDesc}</p>
                 <p class="mt-3">${calosDesc}</p>
                 <p class="mt-2 text-gray-600 italic">É importante saber que essas características, quando vistas nos pés, indicam conflitos dolorosos e observá-las é o primeiro passo para suavizar, acolher e ultrapassá-los.</p>
               `;
          } else {
               // Cenários onde pelo menos uma marca está presente (Sim para Joanetes e/ou Calos, ou Não/Sim) - ATUALIZADO
               joanetesCalosBlock = `
                 <p class="mt-3">${joanetesDesc}</p>
                 <p class="mt-3">${calosDesc}</p>
                 <p class="mt-2 text-gray-600 italic">Essas marcas nos pés mostram pontos onde o corpo endureceu para manter controle, resistir ou suportar o peso emocional não expresso. São sinais de força usada em excesso, quando o corpo precisou se defender em vez de fluir.</p>
                 <p class="mt-2 text-gray-600 italic">Observar essas marcas com atenção é o primeiro passo para transformar o padrão de onde há rigidez e liberar o que foi retido — seja a emoção não expressa ou o medo de se soltá-las.</p>
               `;
          }


          let report = `<p class="mb-2"><strong>${clientName}</strong>, seus pés revelam muito sobre como você pensa, sente e age no mundo. Enquanto a mente racionaliza, os pés simplesmente mostram a verdade. Vamos juntos entender essa linguagem silenciosa?</p>`;
          
          // Formato do Pé (CORRIGIDO)
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Formato do Pé</h4><p class="mt-1">Seu formato de pé <strong>${shape}</strong> traz a primeira pista sobre sua estrutura de pensamento, com tendência a <em>${shapeDesc}</em></p><p class="mt-1 text-gray-600 italic text-sm">Isso não é certo nem errado — é seu jeito único de organizar e interagir com o mundo.</p></div>`;
          
          // Tamanho dos Dedos (CORRIGIDO)
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Tamanho dos Dedos</h4><p class="mt-1">Já seus dedos <strong>${ratioKey}</strong> revelam sua tendência inata para <em>${ratioDesc}</em></p><p class="mt-1 text-gray-600 italic text-sm">Sua força está justamente nessa forma de processar a vida. O convite é dançar no ritmo que equilibre sentir, pensar e agir — um pouco melhor a cada dia.</p></div>`;
          
          // Tamanho das Unhas (CORRIGIDO)
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Tamanho das Unhas</h4><p class="mt-1">Suas unhas <strong>${nailsKey}</strong> mostram como você constrói e lida com suas verdades, geralmente, <em>${nailsDesc}</em></p><p class="mt-1 text-gray-600 italic text-sm">Esse é seu ponto de equilíbrio entre o tradicional e o novo. Toda crença é um abrigo, mas vira prisão se não tiver portas abertas.</p></div>`;
          
          // Sensibilidade e Relação com o Corpo
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Sensibilidade e Relação com o Corpo</h4>`;
          if (tickles === 'Sim') {
            // CORREÇÃO 2: Remove 'que indicam um...' e os reticências
            let ticklesClean = (analysisData['Cócegas nos Pés'][tickles] || '').replace(/Indicam um/i, '').trim();
            // A frase no relatório é: "A sensibilidade quanto às cócegas é um sinal refinado que indicam um... [restante da descrição]".
            // Substituímos a frase do template para remover a repetição e a reticência
            report += `<p class="mt-1">A sensibilidade quanto às cócegas é um sinal refinado que <em>${formatText(lowerCaseFirst(ticklesClean))}</em></p>`;
          } else {
             report += `<p class="mt-1">A ausência de cócegas é um sinal de estabilidade que <em>${formatText(lowerCaseFirst(analysisData['Cócegas nos Pés'][tickles] || ''))}</em></p>`;
          }
          // Relação com os Pés (CORRIGIDO)
          report += `<p class="mt-1">Sua relação com os pés <strong>${relationDisplay}</strong> reflete seu grau de integração com o corpo e emoções, pois <em>${relationDesc}</em></p>`;
          report += `<p class="mt-1 text-gray-600 italic text-sm">Quando há desconforto, há um convite para o autoconhecimento, pois o corpo é o palco onde a psique e o espírito se encontram.</p></div>`;
          
          // Joanetes e Calos
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Joanetes e Calos</h4>${joanetesCalosBlock}</div>`; // Título e Conteúdo atualizados

          // Pontos Fortes e Desafiadores
          // CORREÇÃO 1: Remoção do "a" duplicado. Isso é resolvido garantindo que o `connector` seja anexado diretamente ao texto `challengingPointsList` sem espaços extras.
          report += `<div class="mt-2"><h4 class="text-lg font-bold text-gray-800 mb-1 pb-1 border-b border-gray-200">Pontos Fortes e Desafiadores</h4><p class="mt-1">Seus <strong>pontos fortes</strong> — <em>${strongPointsDesc}</em> — não são só talentos; são sabedoria já instalada.</p><p class="mt-1">O segredo não é lutar contra suas dificuldades, mas usar essa base como trampolim para lidar com seus <strong>pontos desafiadores</strong>${challengingPointsFormatted}.</p></div>`;
          
          // Conclusão
          report += `<div class="mt-3 pt-2 border-t-2 border-green-200"><p class="font-semibold text-gray-700 text-sm">Sabia que a fórmula está no equilíbrio entre ação, emoção e pensamento? Mais uma coisa, use seu instinto não como alarme, mas como radar para a beleza e verdades ainda escondidas.</p><p class="mt-2 text-gray-600 italic text-sm">E lembre-se sempre que puder, que você não é uma máquina, é um organismo pulsante e a vida quer fluir através de você, sem bloqueios. A compreensão sobre si é o primeiro passo para a transformação real, afinal, levar a vida a sério demais é o verdadeiro pecado contra o viver a vida e compreender como você pensa, sente e age não é só uma jornada, é a jornada mais extraordinária de todas!</p></div>`;
          
          report += `<p class="mt-3 text-right text-sm">Fraternos Abraços!<br><strong>Irmo Zuccato Neto</strong></p>`;
          return report;
      }
      
      async function stopCamera() {
        if (currentStream) {
            // Garante que todas as trilhas (tracks) sejam interrompidas
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
            cameraPreview.srcObject = null; // Limpa a referência do vídeo
            cameraPreview.pause(); // Pausa o vídeo
        }
      }
      
      function showBlock(blockToShow) {
        const allBlocks = [splashScreen, personalizationBlock, uploadBlock, cameraBlock, shapeInstructionBlock, ratioInstructionBlock, measurementBlock, shapeResultBlock, ratioResultBlock, nailsQuestionBlock, personalQuestionsBlock, finalReportBlock, previewBlock, legalDocumentsBlock];
        
        // NOVO: Renderiza anúncios ao mostrar o bloco de Personalização ou Relatório Final
        if (blockToShow === personalizationBlock) {
            renderAd('ads-personalization');
        } else if (blockToShow === finalReportBlock) {
            renderAd('ads-final-report');
        }
        // FIM NOVO

        // CORREÇÃO: Força parada da câmera, pois o bloco "camera-block" NÃO será mais usado para capturar
        stopCamera(); 

        // Encontra o bloco ativo antes de escondê-lo
        const currentActiveBlock = allBlocks.find(block => block && block.classList.contains('active-block'));

        allBlocks.forEach(block => {
          if (block && block.classList.contains('active-block')) {
            block.classList.add('hiding');
          }
        });

        setTimeout(() => {
          allBlocks.forEach(block => {
            if (block) block.classList.remove('active-block', 'hiding');
          });
          if (blockToShow) blockToShow.classList.add('active-block');
          
          // NOVO: Rastreia o bloco anterior, exceto se for o bloco legal (para evitar loop)
          if (currentActiveBlock && currentActiveBlock.id !== blockToShow.id && blockToShow.id !== 'legal-documents-block') {
             previousBlockId = currentActiveBlock.id;
          }

          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 300);
      }
      
      function processImageAndContinue(dataUrl) {
        // Se a imagem veio do input file/câmera nativa, pulamos o camera-block e vamos para o preview
        if (currentStream) stopCamera(); // Garante que WebRTC pare (caso estivesse ligado)

        img.onload = () => {
            const maxWidth = 800, maxHeight = 600;
            let { width, height } = img;
            const aspectRatio = img.width / img.height;
            if (img.width > maxWidth || img.height > maxHeight) {
                if (aspectRatio > 1) { width = maxWidth; height = width / aspectRatio; } 
                else { height = maxHeight; width = height * aspectRatio; }
            }
            canvas.width = width;
            canvas.height = height;
            
            // Move diretamente para a tela de pré-visualização (Preview Block)
            photoPreview.src = dataUrl;
            imageUrl = dataUrl;
            currentRotation = 0;
            photoPreview.style.transform = 'rotate(0deg)';
            showBlock(previewBlock);
        };
        img.src = dataUrl;
      }
      
      // Função auxiliar para determinar se o dispositivo é mobile
      function isMobileDevice() {
          return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      // FUNÇÃO DE CONFIGURAÇÃO DE AMBIENTE (NOVO)
      function setupEnvironment() {
          const isMobile = isMobileDevice();
          const openCameraButtonLabel = document.getElementById('open-camera-button-label');
          const cameraError = document.getElementById('camera-error');

          if (isMobile) {
              // Em dispositivos móveis, mostra o botão "Tirar Foto" e esconde a mensagem de erro desktop.
              openCameraButtonLabel.classList.remove('hidden');
              cameraError.classList.add('hidden');
          } else {
              // No desktop, esconde o botão "Tirar Foto" e mostra a mensagem para usar o Upload.
              openCameraButtonLabel.classList.add('hidden');
              cameraError.classList.remove('hidden');
              cameraError.textContent = 'A função "Tirar Foto" está disponível apenas em dispositivos móveis. Por favor, use o botão "Fazer Upload" no computador.';
          }
      }


      function startNewAnalysis() {
        points = []; currentStep = 1; img = new Image(); imageUrl = ''; currentAnalysisPhase = 'shape';
        userName = ''; clientName = ''; shapeResultText = ''; ratioResultText = ''; personalAnswers = {};
        if(personalQuestionsForm) personalQuestionsForm.reset();
        const userNameInput = document.getElementById('user-name-input'); if(userNameInput) userNameInput.value = '';
        const clientNameInput = document.getElementById('client-name-input'); if(clientNameInput) clientNameInput.value = '';
        const analysisTargetSelect = document.getElementById('analysis-target-select'); if(analysisTargetSelect) analysisTargetSelect.value = 'me';
        const clientNameGroup = document.getElementById('client-name-group'); if(clientNameGroup) clientNameGroup.classList.add('step-container');
        
        setupEnvironment(); // Revalida o ambiente ao iniciar nova análise
        showBlock(personalizationBlock);
      }

      function isEgyptianHarmonic(L1, L2, L3, L5) {
          // Lógica anterior (que você pediu para restaurar, mas ajustei para aceitar o caso L1=57, L2=37, L5=44)
          // O L5 ser maior que L3 ou L2 (como no caso do Grego/Romano) quebrava o isEgyptianHarmonic.
          // Para o Egípcio, o Dedão (L1) deve ser o dominante, e L1 > L2 é a regra principal.
          // Permite que L5 seja mais longo que L3 (o que é comum) mas prioriza a dominância de L1
          if (L1 > L2 * 1.07 && L1 > L5) {
              // Verifica se a proporção de caída é "consistente" (não precisa ser harmônica estrita)
              // Verifica se a diferença entre o declínio L1->L2 e L2->L3 não é excessivamente grande
              const d1 = L1 - L2;
              const d2 = L2 - L3;
              if (L2 > L3 && Math.abs(d1 - d2) / Math.max(d1, d2, 1) < 0.6) {
                  return true;
              }
              // Caso L2 > L3 não seja forte, mas L1 é muito dominante
              if (L1 > L2 * 1.2 && L1 > L5 * 1.2) {
                   return true;
              }
          }
          return false;
      }


      function isSquareFoot(L1, L2, L3, L5) {
          // Lógica para o pé Quadrado (dedos centrais de tamanho similar)
          const max = Math.max(L1, L2, L3); 
          const min = Math.min(L1, L2, L3);
          const range = max - min;
          const avg = (L1 + L2 + L3) / 3;
          
          // Se a variação entre os 3 primeiros dedos for pequena (ex: menos de 8% do dedo mais curto)
          if (range / min <= 0.08) return true;

          // Se L2 é o mais longo e L1 e L3 são similares (muito comum em Quadrado-Grego)
          if (L2 > L1 && L2 > L3 && Math.abs(L1 - L3) / Math.min(L1, L3, 1) < 0.15) return true;
          
          return false;
      }

      function classifyShape() {
        if (points.length < 4) return;
        const refY = canvas.height / 2;
        // As coordenadas Y são usadas para medir o comprimento (distância da ponta à linha de referência)
        // L1 (Ponta do Hálux), L2 (Ponta do 2º Dedo), L3 (Ponta do 3º Dedo), L5 (Ponta do 5º Dedo)
        const [L1, L2, L3, L5] = [
            Math.abs(points[0].y - refY), // L1
            Math.abs(points[1].y - refY), // L2
            Math.abs(points[2].y - refY), // L3
            Math.abs(points[3].y - refY)  // L5
        ];
        let shapeText, shapeEmoji, reasoning;
        
        // 1. Prioridade: Egípcio
        if (isEgyptianHarmonic(L1, L2, L3, L5)) {
            [shapeText, shapeEmoji, reasoning] = ['Egípcio', '🌟', 'O dedão é dominante e há uma progressão de declínio perceptível nos dedos adjacentes, indicando predominância do pensamento linear e organização.'];
        
        // 2. Prioridade: Quadrado
        } else if (isSquareFoot(L1, L2, L3, L5)) {
            [shapeText, shapeEmoji, reasoning] = ['Quadrado', '🤖', 'Os dedos centrais têm tamanhos muito semelhantes, com pouca variação, sugerindo uma estrutura de pensamento digital, com foco na integração e coerência entre as partes.'];
            
        // 3. Demais: Grego/Romano (inclui o dedo do meio mais longo)
        } else {
            // Lógica do Grego/Romano Clássico (L2 dominante) ou sequências mistas
            if (L2 > L1 && L2 > L3) {
                [shapeText, shapeEmoji, reasoning] = ['Grego/Romano', '🔍', 'O segundo dedo é o mais longo, uma característica forte do pé Grego, indicando predominância do pensamento sistêmico e detalhismo na elaboração de planos.'];
            } else {
                [shapeText, shapeEmoji, reasoning] = ['Grego/Romano', '🔍', 'O formato apresenta uma sequência que não se encaixa nos padrões Egípcio ou Quadrado, sendo classificado como uma variação do pé Grego/Romano, com tendência ao pensamento sistêmico e à visão global dos processos.'];
            }
        }
        
        shapeResultText = shapeText;
        Object.assign(document.getElementById('shape-text'), { textContent: shapeText });
        Object.assign(document.getElementById('classification-reasoning'), { textContent: reasoning });
        Object.assign(document.getElementById('shape-result-image'), { src: imageUrl });
        ['L1', 'L2', 'L3', 'L5'].forEach((id, i) => { 
            // Os valores no array points para a análise de formato são: L1, L2, L3, L5
            const values = [L1, L2, L3, L5];
            document.getElementById(`${id}-value`).textContent = `${values[i].toFixed(2)} px`; 
        });
        showBlock(shapeResultBlock);
      }


      function classifyRatio(ratio) {
        const diff = Math.abs(ratio - goldenRatioIdeal) / goldenRatioIdeal;
        if (diff <= 0.05) return { text: 'Normais (Análise do Tamanho dos Dedos)', color: 'result-perfect', progressColor: 'progress-bar-perfect' };
        if (ratio <= 2.0) return { text: 'Dedos Longos', color: 'result-very-close', progressColor: 'progress-bar-very-close' };
        if (ratio >= 3.0) return { text: 'Dedos Curtos', color: 'result-far', progressColor: 'progress-bar-far' };
        return ratio > 2.5 ? { text: 'Normais para Curtos', color: 'result-close', progressColor: 'progress-bar-close' } : { text: 'Normais para Longos', color: 'result-close', progressColor: 'progress-bar-close' };
      }

      function calculateAndDisplayResult() {
        if (currentAnalysisPhase === 'ratio') {
          if (points.length < 3) return;
          // pontos: [Ponta 2º, Base 2º, Fim Peito]
          const toeLength = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y); // Distância Ponta -> Base
          const footLength = Math.hypot(points[2].x - points[1].x, points[2].y - points[1].y); // Distância Base -> Peito
          const ratio = footLength / toeLength;
          const classification = classifyRatio(ratio);
          ratioResultText = classification.text.startsWith('Normais para') ? classification.text : classification.text.replace(/Dedos | \(.*\)/g, '').trim();
          document.getElementById('ratio-calculated-ratio').textContent = ratio.toFixed(3);
          document.getElementById('ratio-toe-length').textContent = `${toeLength.toFixed(2)} px`;
          document.getElementById('ratio-foot-length').textContent = `${footLength.toFixed(2)} px`;
          const resultRatioEl = document.getElementById('ratio-result-ratio');
          resultRatioEl.textContent = ratio.toFixed(3);
          resultRatioEl.className = `text-5xl font-extrabold mb-4 ${classification.color}`;
          document.getElementById('ratio-result-text').textContent = classification.text;
          const proximity = 100 - (Math.min(Math.abs(ratio - goldenRatioIdeal) / goldenRatioIdeal, 1) * 100);
          const progressBar = document.getElementById('ratio-progress-bar');
          progressBar.style.width = `${proximity}%`;
          progressBar.className = `absolute h-3 rounded-full transition-all duration-500 ${classification.progressColor}`;
          document.getElementById('ratio-result-image').src = imageUrl;
          showBlock(ratioResultBlock);
        } else if (currentAnalysisPhase === 'shape') {
            classifyShape();
        }
      }
      
      function showFinalReport() {
          let targetName = (document.getElementById('analysis-target-select').value === 'client' ? clientName : userName);
          targetName = targetName.charAt(0).toUpperCase() + targetName.slice(1);
          document.getElementById('report-target-name').textContent = targetName;
          document.getElementById('final-report-image').src = imageUrl;
          document.getElementById('summary-shape').textContent = shapeResultText;
          document.getElementById('summary-ratio').textContent = ratioResultText;
          const displayNailsMap = { 'pouco-visiveis': 'Pouco Visíveis', 'visiveis': 'Visíveis', 'bem-visiveis': 'Bem Visíveis' };
          
          // Captura das novas respostas
          const unhas = personalAnswers.unhas;
          const q1 = personalAnswers.q1;
          const q2 = personalAnswers.q2;
          const q3 = personalAnswers.q3; // Joanetes
          const q4 = personalAnswers.q4; // Calos

          document.getElementById('summary-nails').textContent = displayNailsMap[unhas] || 'N/A';
          document.getElementById('summary-tickles').textContent = q1;
          document.getElementById('summary-relation').textContent = q2;
          document.getElementById('summary-joanetes').textContent = q3;
          document.getElementById('summary-calos').textContent = q4;

          expertAnalysisResult.innerHTML = "Montando a sua análise detalhada...";
          setTimeout(() => {
              expertAnalysisResult.innerHTML = generateFinalReportText(shapeResultText, ratioResultText, unhas, q1, q2, q3, q4);
              showBlock(finalReportBlock);
              loadingSpinner.classList.add('hidden');
              buttonTextSpan.classList.remove('hidden');
              generateFinalReportButton.disabled = false;
          }, 1500); 
      }

      function updateUI() {
        const labels = currentAnalysisPhase === 'shape' ? shapeStepLabels : ratioStepLabels;
        const buttonText = currentAnalysisPhase === 'shape' ? 'Calcular Formato' : 'Calcular Análise do Tamanho dos Dedos';
        document.getElementById('instruction').textContent = currentStep <= labels.length ? `Clique para marcar o ponto ${currentStep}: ${labels[currentStep - 1]}` : `Marcações concluídas. Clique em "${buttonText}".`;
        calculateButton.classList.toggle('hidden', currentStep <= labels.length);
        calculateButton.textContent = buttonText;
        canvas.classList.toggle('custom-cursor', currentStep <= labels.length);
        const progressContainer = document.getElementById('progress-container');
        progressContainer.innerHTML = '';
        progressContainer.className = `mt-4 grid gap-2 grid-cols-${labels.length}`;
        labels.forEach((label, index) => {
          const isCompleted = index < currentStep - 1, isCurrent = index === currentStep - 1;
          const bgColor = isCompleted ? 'bg-green-100 border-green-300 text-green-800' : isCurrent ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-gray-100 border-gray-300 text-gray-600';
          progressContainer.innerHTML += `<div class="p-2 text-sm rounded-lg border text-center ${bgColor}">${index + 1}. ${label}</div>`;
        });
      }

      function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        if (currentAnalysisPhase === 'shape') {
          const refY = canvas.height / 2;
          ctx.beginPath(); ctx.moveTo(0, refY); ctx.lineTo(canvas.width, refY);
          Object.assign(ctx, { strokeStyle: 'rgba(239, 68, 68, 0.1)', lineWidth: 3 }).setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
        }
        points.forEach((point, index) => {
          if (currentAnalysisPhase === 'shape') {
            const refY = canvas.height / 2;
            ctx.beginPath(); ctx.moveTo(point.x, point.y); ctx.lineTo(point.x, refY);
            Object.assign(ctx, { strokeStyle: 'rgba(255, 0, 0, 0.6)', lineWidth: 3 }).stroke();
            if (index > 0) {
              ctx.beginPath(); ctx.moveTo(points[index-1].x, points[index-1].y); ctx.lineTo(point.x, point.y);
              Object.assign(ctx, { strokeStyle: 'rgba(0, 0, 255, 0.3)', lineWidth: 2 }).stroke();
            }
            // NOVO: Usa o valor real do ponto da medição do formato
            const lengthValue = Math.abs(point.y - refY).toFixed(0);
            Object.assign(ctx, { fillStyle: '#ff0000', font: 'bold 12px Arial' }).fillText(`${lengthValue}px`, point.x + 10, (point.y + refY) / 2);
          } else if (currentAnalysisPhase === 'ratio' && points.length >= 2) {
            ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y);
            Object.assign(ctx, { strokeStyle: '#ef4444', lineWidth: 3 }).stroke();
            if (points.length >= 3) {
              ctx.beginPath(); ctx.moveTo(points[1].x, points[1].y); ctx.lineTo(points[2].x, points[2].y);
              Object.assign(ctx, { strokeStyle: '#3b82f6' }).setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
            }
          }
          ctx.beginPath(); ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
          Object.assign(ctx, { fillStyle: currentAnalysisPhase === 'ratio' ? (index < 2 ? '#ef4444' : '#3b82f6') : '#ff0000' }).fill();
          Object.assign(ctx, { strokeStyle: '#ffffff', lineWidth: 2 }).stroke();
          Object.assign(ctx, { fillStyle: '#ffffff', font: 'bold 14px Arial', textAlign: 'center' }).fillText(index + 1, point.x, point.y + 4);
        });
      }

      function resetMeasurement() {
        points = []; currentStep = 1; canvas.classList.add('custom-cursor');
        drawCanvas(); updateUI();
        showBlock(measurementBlock);
      }
      
      function startRatioAnalysis() { currentAnalysisPhase = 'ratio'; points = []; currentStep = 1; showBlock(ratioInstructionBlock); }
      function startShapeAnalysis() { currentAnalysisPhase = 'shape'; points = []; currentStep = 1; showBlock(shapeInstructionBlock); }
      
      // --- Event Listeners ---
      if(startButton) startButton.addEventListener('click', () => { 
          setupEnvironment(); 
          showBlock(personalizationBlock); 
          // CORREÇÃO: Remove a tela inicial e o cabeçalho após o primeiro clique para evitar sobreposição e problemas de layout (fluidity).
          setTimeout(() => {
              if (splashScreen) splashScreen.remove();
              if (appHeaderContainer) appHeaderContainer.remove(); 
          }, 400); // 300ms de transição + 100ms de buffer
      });
      if(document.getElementById('analysis-target-select')) document.getElementById('analysis-target-select').addEventListener('change', e => document.getElementById('client-name-group').classList.toggle('step-container', e.target.value !== 'client'));
      if(continueToUploadButton) continueToUploadButton.addEventListener('click', () => { 
          userName = document.getElementById('user-name-input').value.trim();
          const target = document.getElementById('analysis-target-select').value;
          clientName = target === 'client' ? document.getElementById('client-name-input').value.trim() : '';
          const errorEl = document.getElementById('personalization-error');
          if (!userName || (target === 'client' && !clientName)) return errorEl.classList.remove('hidden');
          errorEl.classList.add('hidden');
          let nameForDisplay = (target === 'client' ? clientName : userName);
          document.getElementById('target-name-display').textContent = nameForDisplay.charAt(0).toUpperCase() + nameForDisplay.slice(1);
          setupEnvironment(); // Aplica a lógica de esconder/mostrar botões
          showBlock(uploadBlock);
      });
      
      // NOVO: Listeners para abrir o bloco de Termos Legais
      const openTermsLinks = document.querySelectorAll('#open-terms-splash, #open-terms-personalization');
      openTermsLinks.forEach(link => {
          link.addEventListener('click', (e) => {
              e.preventDefault();
              showBlock(legalDocumentsBlock);
          });
      });

      // CORREÇÃO: Listener para voltar do bloco de Termos Legais
      if(backFromLegalButton) backFromLegalButton.addEventListener('click', () => {
          // O bloco anterior pode ser splash-screen (se removido) ou personalization-block.
          const targetBlockId = previousBlockId;
          const targetBlock = document.getElementById(targetBlockId);

          if (targetBlock) {
             showBlock(targetBlock);
          } else {
             // Se o bloco anterior foi o splash-screen (e já foi removido pelo startButton),
             // voltamos para a tela de Personalização, que é o primeiro passo de fato.
             showBlock(personalizationBlock);
          }
      });
      
      // LISTENER PARA O INPUT NATIVO DE FOTO (MOBILE)
      if(nativeCameraInput) nativeCameraInput.addEventListener('change', e => e.target.files[0] && (reader => { 
          reader.onload = evt => {
              // Limpa o input após o upload para que o botão "Tirar Outra" funcione
              e.target.value = '';
              processImageAndContinue(evt.target.result);
          }; 
          reader.readAsDataURL(e.target.files[0]); 
      })(new FileReader()));

      // LISTENER PARA O INPUT DE UPLOAD PADRÃO (DESKTOP/MOBILE)
      if(imageUpload) imageUpload.addEventListener('change', e => e.target.files[0] && (reader => { 
          reader.onload = evt => {
              e.target.value = '';
              processImageAndContinue(evt.target.result);
          }; 
          reader.readAsDataURL(e.target.files[0]); 
      })(new FileReader()));


      if(canvas) canvas.addEventListener('click', e => {
        const labels = currentAnalysisPhase === 'shape' ? shapeStepLabels : ratioStepLabels;
        if (currentStep > labels.length) return;
        const rect = canvas.getBoundingClientRect();
        // A lógica de points.push é a mesma para ambos os casos: capturar a coordenada (x, y) do clique no canvas.
        points.push({ x: (e.clientX - rect.left) * (canvas.width / rect.width), y: (e.clientY - rect.top) * (canvas.height / rect.height) });
        currentStep++; drawCanvas(); updateUI();
        if (currentStep > labels.length) {
          canvas.classList.remove('custom-cursor');
          setTimeout(calculateAndDisplayResult, 600);
        }
      });
      if(calculateButton) calculateButton.addEventListener('click', calculateAndDisplayResult);
      if(redoButton) redoButton.addEventListener('click', resetMeasurement);
      if(continueToShapeMeasurement) continueToShapeMeasurement.addEventListener('click', () => { showBlock(measurementBlock); drawCanvas(); updateUI(); });
      if(analyzeRatioButton) analyzeRatioButton.addEventListener('click', startRatioAnalysis);
      // CORREÇÃO: Alterado 'continueToToRatioMeasurement' para 'continueToRatioMeasurement'
      if(continueToRatioMeasurement) continueToRatioMeasurement.addEventListener('click', () => { showBlock(measurementBlock); drawCanvas(); updateUI(); });
      if(backToShapeMeasurementButton) backToShapeMeasurementButton.addEventListener('click', resetMeasurement); 
      if(backToRatioMeasurementButton) backToRatioMeasurementButton.addEventListener('click', resetMeasurement);
      if(newRatioAnalysisButton) newRatioAnalysisButton.addEventListener('click', () => { if (!ratioResultText) { return showBlock(ratioResultBlock); } document.getElementById('nails-result-image').src = imageUrl; showBlock(nailsQuestionBlock); });
      if(continueToPersonalQuestions) continueToPersonalQuestions.addEventListener('click', () => { const unhas = document.querySelector('input[name="nails-visibility"]:checked'); if (!unhas) { return document.getElementById('nails-error').classList.remove('hidden'); } document.getElementById('nails-error').classList.add('hidden'); personalAnswers.unhas = unhas.value; showBlock(personalQuestionsBlock); });
      
      // Listener do Relatório Final (Atualizado para 4 perguntas)
      if(generateFinalReportButton) generateFinalReportButton.addEventListener('click', () => {
          const q1 = document.querySelector('input[name="question1"]:checked'), 
                q2 = document.querySelector('input[name="question2"]:checked'),
                q3 = document.querySelector('input[name="question3"]:checked'),
                q4 = document.querySelector('input[name="question4"]:checked');

          if (!q1 || !q2 || !q3 || !q4) {
             return document.getElementById('questions-error').classList.remove('hidden');
          }
          
          document.getElementById('questions-error').classList.add('hidden');
          personalAnswers.q1 = q1.value; 
          personalAnswers.q2 = q2.value;
          personalAnswers.q3 = q3.value; // Joanetes
          personalAnswers.q4 = q4.value; // Calos

          loadingSpinner.classList.remove('hidden'); 
          buttonTextSpan.classList.add('hidden'); 
          generateFinalReportButton.disabled = true;
          showFinalReport();
      });

      if(startNewFullAnalysisButton) startNewFullAnalysisButton.addEventListener('click', startNewAnalysis);
      
      // Listeners de Ações da Câmera (AGORA USAM O FLUXO NATIVO DE INPUT)
      // O botão retake-photo-button precisa disparar o input nativo novamente
      if(retakePhotoButton) retakePhotoButton.addEventListener('click', () => { 
        currentRotation = 0;
        // Simula o clique no label que ativa o input nativo
        document.getElementById('native-camera-input').click();
      });
      
      // Os botões switch-camera-button e capture-button não são mais usados no fluxo nativo, 
      // mas mantemos o JS deles como fallback caso o fluxo WebRTC fosse reativado.
      
      // openCameraButton (agora label) não precisa de listener complexo, pois o FOR faz o trabalho.

      if(rotateLeftButton) rotateLeftButton.addEventListener('click', () => { currentRotation = (currentRotation - 90) % 360; photoPreview.style.transform = `rotate(${currentRotation}deg)`; });
      if(rotateRightButton) rotateRightButton.addEventListener('click', () => { currentRotation = (currentRotation + 90) % 360; photoPreview.style.transform = `rotate(${currentRotation}deg)`; });
      if(usePhotoButton) usePhotoButton.addEventListener('click', () => { 
        if (!photoPreview.src) return;
        
        // Se houver rotação, aplica permanentemente
        if (currentRotation !== 0) {
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          const tempImg = new Image();
          
          tempImg.onload = () => {
            // Ajusta dimensões do canvas para rotação
            if (currentRotation === 90 || currentRotation === -270 || currentRotation === 270 || currentRotation === -90) {
              tempCanvas.width = tempImg.height;
              tempCanvas.height = tempImg.width;
            } else {
              tempCanvas.width = tempImg.width;
              tempCanvas.height = tempImg.height;
            }
            
            // Aplica a rotação
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate((currentRotation * Math.PI) / 180);
            tempCtx.drawImage(tempImg, -tempImg.width / 2, -tempImg.height / 2);
            
            // Processa a imagem rotacionada
            const rotatedImageData = tempCanvas.toDataURL('image/jpeg', 0.9);
            currentRotation = 0;
            photoPreview.style.transform = 'rotate(0deg)';
            startShapeAnalysis(rotatedImageData); // Inicia a análise com a imagem processada
          };
          
          tempImg.src = photoPreview.src;
        } else {
          startShapeAnalysis(photoPreview.src); // Inicia a análise com a imagem original
        }
      });
      
      // Correção na função startShapeAnalysis para usar a imagem do parâmetro (se houver)
      function startShapeAnalysis(imageOverrideUrl = imageUrl) { 
          currentAnalysisPhase = 'shape'; 
          points = []; 
          currentStep = 1; 
          
          // Força o carregamento da imagem de pré-visualização, caso não tenha sido feito pelo onload
          img.onload = () => {
              // Mantém o tamanho do canvas com base no onload do processImageAndContinue
              showBlock(shapeInstructionBlock); 
              // A próxima tela será a de medição, mas mostramos a instrução primeiro.
          };
          img.src = imageOverrideUrl;
      }
      

      // Listeners de Ações Finais
      const saveAnalysisButton = document.getElementById('save-analysis-button');
      const shareAnalysisButton = document.getElementById('share-analysis-button');

      async function generateAndSavePDF() {
        const reportElement = document.getElementById('final-report-block');
        const targetName = document.getElementById('report-target-name').textContent || 'Cliente';
        const filename = `Analise_dos_Pes_de_${targetName.replace(/\s+/g, '_')}.pdf`;

        // 1. Loading state and disabled buttons
        saveAnalysisButton.textContent = 'Salvando...';
        saveAnalysisButton.disabled = true;
        shareAnalysisButton.disabled = true;

        // ** Armazenar o estado original e reposicionamento temporário **
        const originalParent = reportElement.parentNode;
        const originalNextSibling = reportElement.nextSibling;
        const originalStyle = reportElement.style.cssText;
        const originalClassList = Array.from(reportElement.classList);
        
        // Remove classes de UI e de transição que causam problemas na renderização
        reportElement.classList.remove('active-block', 'step-container', 'hiding');
        
        // Define estilos para forçar o fluxo de bloco e um tamanho previsível para o html2canvas.
        Object.assign(reportElement.style, {
            position: 'static', 
            display: 'block',
            opacity: '1',
            transform: 'none',
            transition: 'none',
            // Configuração CRUCIAL: Define a largura para permitir que o html2canvas calcule o documento inteiro
            // Força a largura para 100% fora do container de app e remove margens que podem ser interpretadas como espaço em branco
            width: '100%', 
            maxWidth: '100%', 
            margin: '0', 
            padding: '25px', 
            boxShadow: 'none',
            border: 'none',
            boxSizing: 'border-box'
        });

        // Temporariamente move o elemento para o body, fora da restrição de #app-main-content
        document.body.appendChild(reportElement);
        
        // Esconde os botões de ação (que não devem aparecer no PDF)
        const actionButtons = reportElement.querySelector('.action-buttons');
        const originalActionButtonsDisplay = actionButtons ? actionButtons.style.display : null;
        if (actionButtons) actionButtons.style.display = 'none';
        
        // NOVO: Esconde o container de anúncios (que não devem aparecer no PDF)
        const adContainer = document.getElementById('ads-final-report');
        const originalAdContainerDisplay = adContainer ? adContainer.style.display : null;
        if (adContainer) adContainer.style.display = 'none';

        // Oculta o container principal para evitar scrollbar dupla e conflitos de layout
        const originalAppMainDisplay = appMainContent.style.display;
        appMainContent.style.display = 'none';

        try {
            // 2. Garante que todas as imagens estejam carregadas
            await ensureImagesLoaded(reportElement);

            // Adiciona atraso para estabilização do DOM
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // 3. Configuração do html2pdf com os requisitos específicos
            const opt = {
              margin: [10, 10, 10, 10],
              filename: filename,
              image: { type: 'jpeg', quality: 0.95 },
              html2canvas: { 
                scale: 1.5, 
                useCORS: true, 
                logging: false,
                scrollX: 0, 
                scrollY: 0, 
                windowWidth: document.documentElement.scrollWidth // Garantir largura total da viewport
              },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
              pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            // 4. Gera e salva o PDF
            await html2pdf().from(reportElement).set(opt).save();

        } catch (err) {
            console.error("Erro ao gerar PDF:", err);
        } finally {
            // 5. Restaura o estado original
            
            // 5.1. Restaura a posição no DOM
            if (originalNextSibling) {
                originalParent.insertBefore(reportElement, originalNextSibling);
            } else if (originalParent) {
                originalParent.appendChild(reportElement);
            }

            // 5.2. Restaura estilos e classes
            reportElement.style.cssText = originalStyle;
            reportElement.className = ''; // Limpa as classes
            originalClassList.forEach(cls => reportElement.classList.add(cls)); // Adiciona as classes originais
            
            // 5.3. Restaura os botões de ação
            if (actionButtons) actionButtons.style.display = originalActionButtonsDisplay;
            
            // NOVO: Restaura o container de anúncios
            if (adContainer) adContainer.style.display = originalAdContainerDisplay;

            // 5.4. Restaura o container principal
            appMainContent.style.display = originalAppMainDisplay;

            // 6. Restaura os botões de controle de análise
            saveAnalysisButton.textContent = 'Salvar Relatório';
            saveAnalysisButton.disabled = false;
            shareAnalysisButton.disabled = false;
        }
      }

      if(saveAnalysisButton) saveAnalysisButton.addEventListener('click', generateAndSavePDF);
      if(shareAnalysisButton) shareAnalysisButton.addEventListener('click', generateAndSavePDF);

      // Listener para cliques nos botões de rádio
      document.querySelectorAll('#personal-questions-form label').forEach(label => label.addEventListener('click', function() { 
          const input = this.querySelector('input[type="radio"]'); 
          if(input) { 
              document.querySelectorAll(`input[name="${input.name}"]`).forEach(r => r.parentElement.classList.remove('border-purple-500', 'bg-purple-100')); 
              this.classList.add('border-purple-500', 'bg-purple-100'); 
              input.checked = true; 
          } 
      }));
    
      document.addEventListener('keydown', e => {
        if (e.key !== 'Enter' || (document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text')) return;
        e.preventDefault();
        const buttonMap = [{b:splashScreen,i:'start-button'},{b:personalizationBlock,i:'continue-to-upload'},{b:shapeInstructionBlock,i:'continue-to-shape-measurement'},{b:shapeResultBlock,i:'analyze-ratio-button'},{b:ratioInstructionBlock,i:'continue-to-ratio-measurement'},{b:measurementBlock,i:'calculate-button',c:()=>currentStep>(currentAnalysisPhase==='shape'?shapeStepLabels.length:ratioStepLabels.length)},{b:ratioResultBlock,i:'new-ratio-analysis-button'},{b:nailsQuestionBlock,i:'continue-to-personal-questions'},{b:personalQuestionsBlock,i:'generate-final-report-button'},{b:finalReportBlock,i:'start-new-full-analysis-button'}];
        const entry = buttonMap.find(item => item.b && item.b.classList.contains('active-block'));
        if (entry && (!entry.c || entry.c())) { const btn = document.getElementById(entry.i); if(btn) btn.id === 'image-upload' ? btn.closest('label').focus() : btn.click(); }
      });
      
      // Chamada da função de setup na inicialização e ao mudar de tela
      document.addEventListener('DOMContentLoaded', setupEnvironment);
      
      // NOVO: RENDERIZA O ANÚNCIO NA TELA INICIAL (SPLASH SCREEN) ASSIM QUE O DOM CARREGA
      // Não é necessário pois a tela de Personalização renderizará o anúncio.
      // renderAd('ads-personalization'); 
    });
  </script>
</body>
</html>
